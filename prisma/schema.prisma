// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// TENANT & USER MANAGEMENT
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, starter, professional, enterprise
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         User[]
  customers     Customer[]
  invoices      Invoice[]
  assets        Asset[]
  warehouses    Warehouse[]
  stockItems    StockItem[]
  transactions  Transaction[]
  notifications Notification[]

  @@index([slug])
  @@index([isActive])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ACCOUNTANT
  WAREHOUSE_MANAGER
  SALES
  USER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  fullName     String?
  firstName    String?
  lastName     String?
  role         Role     @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  transactions    Transaction[]
  createdInvoices Invoice[]      @relation("InvoiceCreator")
  notifications   Notification[]
  tokens          Tokens[]
  tenant          Tenant?        @relation(fields: [tenantId], references: [id])
  tenantId        String?

  @@index([email])
  @@index([role])
}

model Tokens {
  id         Int       @id @default(autoincrement())
  type       String?
  value      String?   @unique
  expiresAt  DateTime?
  deviceInfo String?
  ipAddress  String?
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @default(now()) @updatedAt
  userId     String
  users      User?     @relation(fields: [userId], references: [id])

  @@index([expiresAt])
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  address   String?
  city      String?
  country   String?
  taxId     String?
  image     String?
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
}

// ============================================
// INVOICE & FINANCIAL MANAGEMENT
// ============================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  customerId    String
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(15, 2)
  tax           Decimal       @default(0) @db.Decimal(15, 2)
  discount      Decimal       @default(0) @db.Decimal(15, 2)
  total         Decimal       @db.Decimal(15, 2)
  notes         String?
  tenantId      String
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer    Customer      @relation(fields: [customerId], references: [id])
  createdBy   User          @relation("InvoiceCreator", fields: [createdById], references: [id])
  items       InvoiceItem[]
  transaction Transaction?

  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceNumber])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ============================================
// ASSET MANAGEMENT
// ============================================

enum AssetStatus {
  ACTIVE
  MAINTENANCE
  RETIRED
  SOLD
}

model Asset {
  id            String      @id @default(cuid())
  name          String
  description   String?
  serialNumber  String?
  purchaseDate  DateTime
  purchasePrice Decimal     @db.Decimal(15, 2)
  currentValue  Decimal     @db.Decimal(15, 2)
  status        AssetStatus @default(ACTIVE)
  location      String?
  category      String
  tenantId      String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([category])
}

// ============================================
// WAREHOUSE & STOCK MANAGEMENT
// ============================================

model Warehouse {
  id        String   @id @default(cuid())
  name      String
  location  String
  capacity  Int?
  isActive  Boolean  @default(true)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockItems StockItem[]

  @@index([tenantId])
  @@index([isActive])
}

model StockItem {
  id          String   @id @default(cuid())
  sku         String
  name        String
  description String?
  quantity    Int      @default(0)
  minQuantity Int      @default(0)
  unitPrice   Decimal  @db.Decimal(15, 2)
  warehouseId String
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([sku, tenantId])
  @@index([tenantId])
  @@index([warehouseId])
  @@index([sku])
}

// ============================================
// TRANSACTION MANAGEMENT (Money)
// ============================================

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model Transaction {
  id          String            @id @default(cuid())
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  amount      Decimal           @db.Decimal(15, 2)
  currency    String            @default("USD")
  description String
  reference   String?
  invoiceId   String?           @unique
  processedAt DateTime?
  tenantId    String
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User     @relation(fields: [createdById], references: [id])
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

model Notification {
  id        String              @id @default(cuid())
  userId    String
  tenantId  String
  type      NotificationType    @default(INFO)
  channel   NotificationChannel @default(IN_APP)
  title     String
  message   String
  isRead    Boolean             @default(false)
  data      Json?
  sentAt    DateTime?
  createdAt DateTime            @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationJob {
  id        String    @id @default(uuid())
  name      String // e.g., "send-notification"
  payload   Json // Stores channel, recipient, title, message, etc.
  status    JobStatus @default(PENDING)
  attempts  Int       @default(0)
  error     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([status, createdAt]) // Index to speed up worker polling
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
